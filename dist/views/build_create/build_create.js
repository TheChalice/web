angular.module("console.build.create",[]).controller("BuildCreateCtrl",["$scope","$state","$log","BuildConfig","Build","ImageStream","UUID","Alert",function(e,t,n,r,i,s,o,u){n.info("BuildCreate"),e.buildConfig={metadata:{name:""},spec:{triggers:[],source:{type:"Git",git:{uri:""}},strategy:{type:"Docker"},output:{to:{kind:"ImageStreamTag",name:""}},completionDeadlineSeconds:1800}},e.completionDeadlineMinutes=30,e.create=function(){var t={metadata:{name:e.buildConfig.metadata.name},spec:{tags:[{name:"latest"}]}};s.create({},t,function(e){n.info("imageStream",e),a(e.metadata.name)},function(t){n.info("err",t),t.data.code==409?a(e.buildConfig.metadata.name):u.open("错误",t.data.message,!0)})};var a=function(t){e.buildConfig.spec.completionDeadlineSeconds=e.completionDeadlineMinutes*60,e.buildConfig.spec.output.to.name=t+":latest",e.buildConfig.spec.triggers=[{type:"GitHub",github:{secret:o.guid().replace(/-/g,"")}}],r.create({},e.buildConfig,function(e){n.info("buildConfig",e),f(e.metadata.name)},function(e){e.data.code==409?u.open("错误","构建名称重复",!0):u.open("错误",e.data.message,!0)})},f=function(e){var i={metadata:{name:e}};r.instantiate.create({name:e},i,function(){n.info("build instantiate success"),t.go("console.build_detail",{name:e,from:"create"})},function(e){})}}]);